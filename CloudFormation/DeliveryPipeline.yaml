AWSTemplateFormatVersion: '2010-09-09'
Description: CodePipeline template
Resources:
  CloudFormationRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              AWS:
                - "arn:aws:iam::871404303724:user/alex"
              Service:
                - cloudformation.amazonaws.com
                - lambda.amazonaws.com
              Action:
                - sts:AssumeRole
        Path: "/"
        Policies:
          - PolicyName: 'CloudFormationRolePolicy'
            PolicyDocument:
              Version: "2012-10-17"
              Statement:
                - Effect: Allow
                  Action:
                    - 'cloudformation:ContinueUpdateRollback'              
                    - 'cloudformation:CreateStack'
                    - 'cloudformation:DescribeStacks' 
                    - 'cloudformation:DescribeStackEvents'
                    - 'cloudformation:UpdateStack'
                    - 'cloudformation:ValidateTemplate'
                    - 's3:*'
                    - 'iam:CreateRole'
                    - 'iam:DeleteRole'
                    - 'iam:GetRole'
                    - 'iam:ListRoles'
                    - 'iam:PassRole'
                    - 'iam:AttachRolePolicy'
                    - 'iam:DetachRolePolicy'
                    - 'iam:PutRolePolicy'
                    - 'iam:DeleteRolePolicy'
                    - 'iam:GetInstanceProfile'
                    - 'iam:ListInstanceProfiles'
                    - 'iam:CreateInstanceProfile'
                    - 'iam:DeleteInstanceProfile'
                    - 'iam:ListInstanceProfilesForRole'
                    - 'iam:AddRoleToInstanceProfile'
                    - 'iam:RemoveRoleFromInstanceProfile'
                    - 'elasticmapreduce:DeleteEditor'
                    - 'elasticmapreduce:ListBootstrapActions'
                    - 'elasticmapreduce:CreateEditor'
                    - 'elasticmapreduce:CreateSecurityConfiguration'
                    - 'elasticmapreduce:DescribeCluster'
                    - 'elasticmapreduce:SetTerminationProtection'
                    - 'elasticmapreduce:ListInstanceGroups'
                    - 'elasticmapreduce:DescribeStep'
                    - 'elasticmapreduce:ListInstances'
                    - 'elasticmapreduce:ListSecurityConfigurations'
                    - 'elasticmapreduce:DeleteSecurityConfiguration'
                    - 'elasticmapreduce:StopEditor'
                    - 'elasticmapreduce:ListClusters'
                    - 'elasticmapreduce:DescribeEditor'
                    - 'elasticmapreduce:TerminateJobFlows'
                    - 'elasticmapreduce:DescribeSecurityConfiguration'
                    - 'elasticmapreduce:ViewEventsFromAllClustersInConsole'
                    - 'elasticmapreduce:ListSteps'
                    - 'elasticmapreduce:OpenEditorInConsole'
                    - 'elasticmapreduce:ListInstanceFleets'
                    - 'elasticmapreduce:PutAutoScalingPolicy'
                    - 'elasticmapreduce:AddInstanceGroups'
                    - 'elasticmapreduce:ModifyInstanceFleet'
                    - 'elasticmapreduce:StartEditor'
                    - 'elasticmapreduce:ModifyInstanceGroups'
                    - 'elasticmapreduce:RemoveAutoScalingPolicy'
                    - 'elasticmapreduce:RemoveTags'
                    - 'elasticmapreduce:AddInstanceFleet'
                    - 'elasticmapreduce:RunJobFlow'
                    - 'elasticmapreduce:AddJobFlowSteps'
                    - 'elasticmapreduce:AddTags'
                    - 'elasticmapreduce:ListEditors'
                    - 'elasticmapreduce:CancelSteps'
                    - 'states:ListStateMachines'
                    - 'states:DescribeActivity'
                    - 'states:DescribeStateMachine'
                    - 'states:ListActivities'
                    - 'states:ListExecutions'
                    - 'states:CreateActivity'
                    - 'states:UpdateStateMachine'
                    - 'states:DeleteStateMachine'
                    - 'states:StopExecution'
                    - 'states:UntagResource'
                    - 'states:TagResource'
                    - 'states:DescribeStateMachineForExecution'
                    - 'states:SendTaskSuccess'
                    - 'states:SendTaskFailure'
                    - 'states:DescribeExecution'
                    - 'states:GetExecutionHistory'
                    - 'states:DeleteActivity'
                    - 'states:StartExecution'
                    - 'states:SendTaskHeartbeat'
                    - 'states:GetActivityTask'
                    - 'states:CreateStateMachine'
                    - 'states:ListTagsForResource'
                    - 'sns:*'
                    - 'events:*'
                    - 'cloudwatch:*'
                    - 'lambda:*'
                  Resource: '*'
  CodePipelineServiceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          -
            Effect: "Allow"
            Principal:
              AWS:
                - "arn:aws:iam::871404303724:user/alex"
              Service:
                - "cloudformation.amazonaws.com"
              Action:
                - "sts:AssumeRole"
        Path: "/"
        Policies:
          - PolicyName: 'CodePipelineServiceRolePolicy'
            PolicyDocument:
              Version: "2012-10-17"
              Statement:
                - Effect: Allow
                  Action:
                    - 'cloudformation:ContinueUpdateRollback'
                    - 'cloudformation:CreateStack'
                    - 'cloudformation:DescribeStacks'
                    - 'cloudformation:DescribeStackEvents'
                    - 'cloudformation:UpdateStack'
                    - 'cloudformation:ValidateTemplate'
                    - 's3:*'
                    - 'iam:CreateRole'
                    - 'iam:DeleteRole'
                    - 'iam:GetRole'
                    - 'iam:ListRoles'
                    - 'iam:PassRole'
                    - 'iam:AttachRolePolicy'
                    - 'iam:DetachRolePolicy'
                    - 'iam:PutRolePolicy'
                    - 'iam:DeleteRolePolicy'
                    - 'iam:GetInstanceProfile'
                    - 'iam:ListInstanceProfiles'
                    - 'iam:CreateInstanceProfile'
                    - 'iam:DeleteInstanceProfile'
                    - 'iam:ListInstanceProfilesForRole'
                    - 'iam:AddRoleToInstanceProfile'
                    - 'iam:RemoveRoleFromInstanceProfile'
                    - 'elasticmapreduce:DeleteEditor'
                    - 'elasticmapreduce:ListBootstrapActions'
                    - 'elasticmapreduce:CreateEditor'
                    - 'elasticmapreduce:CreateSecurityConfiguration'
                    - 'elasticmapreduce:DescribeCluster'
                    - 'elasticmapreduce:SetTerminationProtection'
                    - 'elasticmapreduce:ListInstanceGroups'
                    - 'elasticmapreduce:DescribeStep'
                    - 'elasticmapreduce:ListInstances'
                    - 'elasticmapreduce:ListSecurityConfigurations'
                    - 'elasticmapreduce:DeleteSecurityConfiguration'
                    - 'elasticmapreduce:StopEditor'
                    - 'elasticmapreduce:ListClusters'
                    - 'elasticmapreduce:DescribeEditor'
                    - 'elasticmapreduce:TerminateJobFlows'
                    - 'elasticmapreduce:DescribeSecurityConfiguration'
                    - 'elasticmapreduce:ViewEventsFromAllClustersInConsole'
                    - 'elasticmapreduce:ListSteps'
                    - 'elasticmapreduce:OpenEditorInConsole'
                    - 'elasticmapreduce:ListInstanceFleets'
                    - 'elasticmapreduce:PutAutoScalingPolicy'
                    - 'elasticmapreduce:AddInstanceGroups'
                    - 'elasticmapreduce:ModifyInstanceFleet'
                    - 'elasticmapreduce:StartEditor'
                    - 'elasticmapreduce:ModifyInstanceGroups'
                    - 'elasticmapreduce:RemoveAutoScalingPolicy'
                    - 'elasticmapreduce:RemoveTags'
                    - 'elasticmapreduce:AddInstanceFleet'
                    - 'elasticmapreduce:RunJobFlow'
                    - 'elasticmapreduce:AddJobFlowSteps'
                    - 'elasticmapreduce:AddTags'
                    - 'elasticmapreduce:ListEditors'
                    - 'elasticmapreduce:CancelSteps'
                    - 'states:ListStateMachines'
                    - 'states:DescribeActivity'
                    - 'states:DescribeStateMachine'
                    - 'states:ListActivities'
                    - 'states:ListExecutions'
                    - 'states:CreateActivity'
                    - 'states:UpdateStateMachine'
                    - 'states:DeleteStateMachine'
                    - 'states:StopExecution'
                    - 'states:UntagResource'
                    - 'states:TagResource'
                    - 'states:DescribeStateMachineForExecution'
                    - 'states:SendTaskSuccess'
                    - 'states:SendTaskFailure'
                    - 'states:DescribeExecution'
                    - 'states:GetExecutionHistory'
                    - 'states:DeleteActivity'
                    - 'states:StartExecution'
                    - 'states:SendTaskHeartbeat'
                    - 'states:GetActivityTask'
                    - 'states:CreateStateMachine'
                    - 'states:ListTagsForResource'
                    - 'sns:*'
                    - 'events:*'
                    - 'cloudwatch:*'
                    - 'lambda:*'
                  Resource: '*'
  DeliveryPipeline:
    Type: AWS::CodePipeline::Pipeline
    Properties:
      RoleArn:
        Ref: CodePipelineServiceRole
      ArtifactStore:
        Type: S3
        Location: 'codepipeline.test.templates.pipeline'
      Stages:
        -
          Name: Source
          Actions:
            -
              Name: SourceAction
              ActionTypeId:
                Category: Source
                Owner: AWS
                Version: 1
                Provider: S3
              Configuration:
                S3Bucket: 'codepipeline.test.templates'
                S3ObjectKey: 'artifacts/iac.zip'
              OutputArtifacts:
                -
                  Name: my-project-BuildArtifact
              RunOrder: 1
        -
          Name: CF_Deploy
          Actions:
            -
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: CloudFormation
                Version: '1'
              Configuration:
                ActionMode: CREATE_UPDATE
                Capabilities: CAPABILITY_IAM,CAPABILITY_NAMED_IAM,CAPABILITY_AUTO_EXPAND
                RoleArn:
                  Ref: CloudFormationRole
                StackName: my-project--testName
                TemplateConfiguration: 'my-project--BuildArtifact::template-configuration.json'
                TemplatePath: 'my-project--BuildArtifact::template-export.yml'
              OutputArtifacts: [ ]
              InputArtifacts:
                - Name: my-project-BuildArtifact
              RunOrder: 1